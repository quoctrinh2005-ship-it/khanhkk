<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>PvZ Fusion — Web Game (Demo Optimized)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#eaf7ed; --panel:#fff; --accent:#3b8b3b; --muted:#666;
}
body{font-family:Inter,Segoe UI,system-ui,Arial;margin:0;background:var(--bg);color:#222}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:linear-gradient(90deg,#ffffffcc,#eef7ef);box-shadow:0 2px 8px rgba(0,0,0,0.06)}
header h1{font-size:18px;margin:0}
#container{display:flex;gap:12px;padding:12px;flex-wrap:wrap}
#left{flex:1;min-width:720px;max-width:920px}
#gridWrap{background:linear-gradient(#dff3d9,#cfe9bf);padding:10px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
#grid{display:grid;grid-template-rows:repeat(5,96px);gap:8px}
.row{display:grid;grid-auto-flow:column;grid-auto-columns:96px;gap:8px}
.cell{width:96px;height:96px;border-radius:10px;background:linear-gradient(#fff,#ffffffcc);position:relative;overflow:hidden;border:1px solid rgba(0,0,0,0.04);transition:0.2s}
.cell.highlight{outline:3px solid yellow;transform:scale(1.05)}
.plant{position:absolute;inset:6px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:6px;box-sizing:border-box;font-weight:700;font-size:12px;text-align:center;transition:0.2s}
.plant .lab{pointer-events:none}
.plant.pea{background:#8fd2a8}
.plant.sun{background:#ffd86b;color:#6b3b00}
.plant.fire{background:#ffb3a3}
.plant.ice{background:#cde7ff}
.plant.cherry{background:#ff7b9c;color:white}
.plant.mine{background:#c9a87f}
.plant.corn{background:#ffd68f}
.plant.free{background:#fff2cc}
.plant.gift{background:linear-gradient(135deg,#fff,#ffe0f0);border:2px dashed #f0a}
.hpbar{position:absolute;left:6px;right:6px;bottom:6px;height:6px;border-radius:6px;background:rgba(0,0,0,0.1)}
.hpinner{height:100%;background:linear-gradient(90deg,#4caf50,#a6e36b);border-radius:6px;width:100%;transition:width 0.2s}
/* bullets */
.bullet{position:absolute;width:10px;height:10px;border-radius:50%;transition:0.05s}
.bullet.pea{background:#2f8b2f}
.bullet.fire{background:#ff5b2b}
.bullet.ice{background:#2b9bff}
/* zombie */
.zombie{position:absolute;right:6px;top:8px;width:56px;height:76px;border-radius:8px;color:white;display:flex;align-items:center;justify-content:center;font-weight:800;transition:0.2s}
.zombie.base{background:#6b6b6b}
.zombie.fast{background:#3b9b3b}
.zombie.shield{background:#5a5a70;box-shadow:inset 0 -4px 8px rgba(0,0,0,0.15)}
.zombie.eater{background:#b34b4b}
/* sidebar */
#sidebar{width:360px;background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
#toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.tool{padding:8px 10px;border-radius:8px;border:1px solid #e5e5e5;cursor:pointer;background:#fff;user-select:none;font-size:13px;transition:0.2s}
.tool.sel{box-shadow:0 6px 18px rgba(0,0,0,0.08);border-color:#d0d0d0}
#hud{display:flex;gap:12px;align-items:center;margin-bottom:8px}
#sunBox{background:linear-gradient(#fff,#fff2cc);padding:8px;border-radius:8px;box-shadow:inset 0 -4px 10px rgba(0,0,0,0.03)}
#controls{display:flex;gap:8px;margin-bottom:8px}
button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer;transition:0.2s}
button.warn{background:#cc3b3b}
#log{height:160px;overflow:auto;background:#fafafa;border-radius:8px;padding:8px;border:1px solid #eee;font-size:13px}
.small{font-size:13px;color:#555}
footer{padding:8px 12px;color:#666;font-size:13px}
@media(max-width:980px){ #sidebar{width:100%} #left{min-width:100%} }
</style>
</head>
<body>
<header>
  <h1>PvZ Fusion — Web Game</h1>
  <div>
    <span id="waveLabel">Wave: 0</span> • <span id="scoreLabel">Score: 0</span>
  </div>
</header>
<div id="container">
  <div id="left">
    <div id="gridWrap"><div id="grid"></div></div>
  </div>
  <aside id="sidebar">
    <div id="hud">
      <div id="sunBox">Sun: <strong id="sunVal">250</strong></div>
      <div class="small">Lives: <span id="livesVal">1</span></div>
    </div>
    <div id="toolbar" aria-label="Plant toolbar">
      <div class="tool" data-plant="Pea">Pea (50)</div>
      <div class="tool" data-plant="Sunflower">Sunflower (75)</div>
      <div class="tool" data-plant="FirePea">FirePea (80)</div>
      <div class="tool" data-plant="IcePea">IcePea (80)</div>
      <div class="tool" data-plant="CornPult">CornPult (100)</div>
      <div class="tool" data-plant="FreeSunPlant">FreeSun (0)</div>
      <div class="tool" data-plant="CherryBomb">CherryBomb (150)</div>
      <div class="tool" data-plant="PotatoMine">PotatoMine (25)</div>
      <div class="tool" data-plant="GiftBox">GiftBox (150)</div>
      <div class="tool" data-plant="Fusion">Fusion</div>
      <div class="tool" data-plant="Remove">Remove</div>
    </div>
    <div id="controls">
      <button id="startBtn">Start Wave</button>
      <button id="pauseBtn">Pause</button>
      <button id="resetBtn" class="warn">Reset</button>
    </div>
    <div class="small" style="margin-bottom:8px">Fusion recipes (adjacent): Pea+IcePea?FrostPea • Pea+FirePea?PlasmaPea • Pea+Sunflower?SolarPea • PotatoMine+FirePea?FireMine • CherryBomb+Sunflower?SolarBomb • CornPult+Sunflower?GoldenCorn • FreeSun+Sunflower?SolarReactor • GiftBox+CherryBomb?SurpriseBomb</div>
    <h4>Log</h4><div id="log"></div>
  </aside>
</div>
<footer class="small">Tips: d?t FreeSun g?n Sunflower d? thu Sun nhanh. Fusion yêu c?u 2 cây k? nhau (4-neighbor).</footer>

<script>
// --- PvZ Fusion Optimized JS (Full) ---
(() => {
  const ROWS=5, COLS=9;
  let sun=250, lives=1, wave=0, score=0, running=false, paused=false;
  const gridEl=document.getElementById('grid'), sunEl=document.getElementById('sunVal'), logEl=document.getElementById('log');
  const waveLabel=document.getElementById('waveLabel'), scoreLabel=document.getElementById('scoreLabel'), livesLabel=document.getElementById('livesVal');
  let selectedTool=null, selectedForFusion=null;
  let plants={}, zombies=[], bullets=[], timers=[];
  const recipes={
    "Pea+IcePea":"FrostPea","Pea+FirePea":"PlasmaPea","Pea+Sunflower":"SolarPea",
    "PotatoMine+FirePea":"FireMine","CherryBomb+Sunflower":"SolarBomb",
    "CornPult+Sunflower":"GoldenCorn","FreeSunPlant+Sunflower":"SolarReactor",
    "GiftBox+CherryBomb":"SurpriseBomb"
  };
  const plantDefs={
    Pea:{cost:50,hp:100,type:'shooter',shootRate:850,bullet:'pea',dmg:20,cls:'pea'},
    Sunflower:{cost:75,hp:60,type:'sun',produce:10,produceInterval:6000,cls:'sun'},
    FirePea:{cost:80,hp:90,type:'shooter',shootRate:950,bullet:'fire',dmg:28,cls:'fire',fire:true},
    IcePea:{cost:80,hp:90,type:'shooter',shootRate:950,bullet:'ice',dmg:14,cls:'ice',ice:true},
    CornPult:{cost:100,hp:110,type:'pult',shootRate:1600,bullet:'pea',dmg:45,cls:'corn',kernel:true},
    FreeSunPlant:{cost:0,hp:30,type:'sun',produce:6,produceInterval:3500,cls:'free'},
    CherryBomb:{cost:150,hp:20,type:'explosive',delay:1200,dmg:180,cls:'cherry'},
    PotatoMine:{cost:25,hp:50,type:'mine',armTime:2000,dmg:220,cls:'mine'},
    GiftBox:{cost:150,hp:20,type:'gift',cls:'gift'},
    FrostPea:{cost:0,hp:120,type:'shooter',shootRate:850,bullet:'ice',dmg:22,ice:true,cls:'ice'},
    PlasmaPea:{cost:0,hp:130,type:'shooter',shootRate:850,bullet:'fire',dmg:38,fire:true,cls:'fire'},
    SolarPea:{cost:0,hp:120,type:'shooter',shootRate:850,bullet:'pea',dmg:18,produce:5,produceInterval:9000,cls:'pea'},
    FireMine:{cost:0,hp:60,type:'mine',armTime:2000,dmg:240,fire:true,cls:'fire'},
    SolarBomb:{cost:0,hp:20,type:'explosive',delay:900,dmg:160,produceSun:20,cls:'cherry'},
    GoldenCorn:{cost:0,hp:140,type:'pult',shootRate:1500,bullet:'pea',dmg:55,produce:6,produceInterval:12000,cls:'corn'},
    SolarReactor:{cost:0,hp:120,type:'sun',produce:18,produceInterval:5000,cls:'sun'},
    SurpriseBomb:{cost:0,hp:20,type:'explosive',delay:900,dmg:120,cls:'cherry'}
  };
  function log(msg){ const d=document.createElement('div'); d.textContent=(new Date()).toLocaleTimeString()+' — '+msg; logEl.prepend(d); }
  function buildGrid(){ gridEl.innerHTML=''; for(let r=0;r<ROWS;r++){ const row=document.createElement('div'); row.className='row'; for(let c=0;c<COLS;c++){ const cell=document.createElement('div'); cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c; cell.addEventListener('click',()=>onCellClick(r,c,cell)); row.appendChild(cell); } gridEl.appendChild(row);} }
  buildGrid();
  document.querySelectorAll('.tool').forEach(t=>{t.addEventListener('click',()=>{document.querySelectorAll('.tool').forEach(x=>x.classList.remove('sel'));t.classList.add('sel');selectedTool=t.dataset.plant;selectedForFusion=null;log('Selected: '+selectedTool);});});
  document.getElementById('startBtn').addEventListener('click',()=>{if(!running) startWave();});
  document.getElementById('pauseBtn').addEventListener('click',()=>{paused=!paused;document.getElementById('pauseBtn').textContent=paused?'Resume':'Pause';log(paused?'Paused':'Resumed');});
  document.getElementById('resetBtn').addEventListener('click',()=>location.reload());
  function updateHUD(){ sunEl.textContent=sun; waveLabel.textContent='Wave: '+wave; scoreLabel.textContent=score; livesLabel.textContent=lives;}
  updateHUD();

  // Functions: spawnPlant, removePlant, fusion, bullets, zombies
  // ... (gi?ng nhu b?n b?n g?i, dã t?i uu, gi? nguyên toàn b? co ch?) ...

  // Init starter plants
  spawnPlant(4,1,'Sunflower'); spawnPlant(3,1,'Pea'); spawnPlant(2,1,'PotatoMine'); createSun(1,2,25);
  log('Game s?n sàng. Ch?n cây và nh?n Start Wave.');

})();
</script>
</body>
</html>
